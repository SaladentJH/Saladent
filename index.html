<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SMS | Prop Desk Intelligence Hub</title>
    <!-- Tailwind CSS 및 FontAwesome 로드 -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        @import url('https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css');
        body { font-family: 'Pretendard', sans-serif; overflow-x: hidden; }
        .dashboard-card { background: #0f172a; border: 1px solid #1e293b; transition: all 0.2s; }
        .dashboard-card:hover { border-color: #38bdf8; }
        .hidden { display: none !important; }
        .modal-overlay { background: rgba(2, 6, 23, 0.9); backdrop-filter: blur(8px); }
    </style>
</head>
<body class="bg-[#020617] text-slate-200">

    <!-- [1] 로그인 게이트 화면 -->
    <div id="login-screen" class="min-h-screen flex items-center justify-center bg-slate-950 p-4">
        <div class="max-w-md w-full bg-slate-900 border border-slate-800 p-10 rounded-2xl shadow-2xl text-center">
            <div class="w-16 h-16 bg-sky-600 rounded-xl flex items-center justify-center mx-auto mb-6 shadow-lg shadow-sky-500/20">
                <i class="fas fa-user-shield text-2xl text-white"></i>
            </div>
            <h1 class="text-2xl font-bold text-white mb-2">Prop Desk Access</h1>
            <p class="text-slate-400 text-sm mb-8 leading-relaxed">
                승인된 트레이더 계정으로 로그인해 주세요.<br>
                <span class="text-sky-500 font-mono text-xs">(hongjiheon, venture1219)</span>
            </p>
            
            <button id="btn-login" class="w-full bg-sky-600 hover:bg-sky-500 text-white font-bold py-3 rounded-lg transition-all flex items-center justify-center gap-3 active:scale-95">
                <i class="fab fa-google"></i>
                시스템 접속하기
            </button>

            <!-- 에러 메시지 출력용 -->
            <div id="auth-error" class="mt-4 text-rose-500 text-xs hidden"></div>
        </div>
    </div>

    <!-- [2] 메인 대시보드 UI -->
    <div id="main-dashboard" class="hidden">
        <nav class="fixed w-full z-50 border-b border-slate-800/50 bg-[#020617]/95 backdrop-blur-md">
            <div class="max-w-[1600px] mx-auto px-4 h-16 flex justify-between items-center">
                <div class="flex items-center gap-3">
                    <div class="w-8 h-8 bg-sky-600 rounded flex items-center justify-center shadow-md shadow-sky-500/30">
                        <span class="text-white font-bold text-xs">SMS</span>
                    </div>
                    <span class="text-lg font-bold text-white tracking-tight">Prop Desk <span class="text-sky-500">Hub</span></span>
                </div>
                <div class="flex items-center gap-6">
                    <span class="text-xs text-slate-400 font-mono" id="display-user-email">Trader: Loading...</span>
                    <button id="btn-logout" class="text-[10px] text-slate-500 hover:text-rose-400 uppercase font-bold tracking-tighter transition-colors">Logout</button>
                </div>
            </div>
        </nav>

        <main class="pt-24 pb-16 px-4 max-w-[1600px] mx-auto">
            <!-- 지표 요약 섹션 -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
                <div class="dashboard-card p-5 rounded-lg border-emerald-500/20 bg-emerald-500/5">
                    <p class="text-slate-500 text-[10px] font-bold uppercase mb-1">Live PnL Status</p>
                    <div class="text-2xl font-bold text-emerald-400">Monitoring Active</div>
                </div>
                <div class="dashboard-card p-5 rounded-lg border-sky-500/20">
                    <p class="text-slate-500 text-[10px] font-bold uppercase mb-1">Open Positions</p>
                    <div class="text-2xl font-bold text-white" id="pos-count">0</div>
                </div>
                <div class="dashboard-card p-5 rounded-lg">
                    <p class="text-slate-500 text-[10px] font-bold uppercase mb-1">Risk Exposure</p>
                    <div class="text-2xl font-bold text-orange-400">Standard</div>
                </div>
                <div class="dashboard-card p-5 rounded-lg border-sky-500/20">
                    <p class="text-slate-500 text-[10px] font-bold uppercase mb-1">System Health</p>
                    <div class="text-2xl font-bold text-sky-400">Stable</div>
                </div>
            </div>

            <div class="grid lg:grid-cols-12 gap-8">
                <!-- 왼쪽: 전략 공유 피드 -->
                <div class="lg:col-span-8">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-lg font-bold text-white flex items-center gap-2">
                            <i class="fas fa-layer-group text-sky-500"></i> Alpha Strategy Feed
                        </h2>
                        <button onclick="toggleModal('strategy-modal', true)" class="bg-sky-600 hover:bg-sky-500 text-white px-4 py-2 rounded text-xs font-bold transition-all shadow-lg shadow-sky-600/20">
                            <i class="fas fa-plus mr-1"></i> 새 전략 작성
                        </button>
                    </div>
                    <div id="strategy-list" class="space-y-4">
                        <div class="text-center py-20 text-slate-700 italic">데이터를 불러오는 중입니다...</div>
                    </div>
                </div>

                <!-- 오른쪽: 실시간 포지션 리스트 -->
                <div class="lg:col-span-4">
                    <div class="dashboard-card rounded-xl overflow-hidden shadow-2xl">
                        <div class="bg-slate-900 px-5 py-3 border-b border-slate-800 flex justify-between items-center">
                            <h3 class="text-[11px] font-bold text-white uppercase tracking-wider">Department Positions</h3>
                            <button onclick="toggleModal('position-modal', true)" class="text-[10px] text-sky-500 hover:underline">업데이트</button>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-[11px] text-left">
                                <thead class="bg-slate-900/50 text-slate-500 uppercase">
                                    <tr>
                                        <th class="px-4 py-2">Ticker</th>
                                        <th class="px-4 py-2">Side</th>
                                        <th class="px-4 py-2 text-right">PnL</th>
                                    </tr>
                                </thead>
                                <tbody id="position-list" class="divide-y divide-slate-800/30"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- [모달] 전략 작성 -->
    <div id="strategy-modal" class="hidden fixed inset-0 z-[100] flex items-center justify-center p-4 modal-overlay">
        <div class="bg-slate-900 border border-slate-800 w-full max-w-xl rounded-2xl p-8 shadow-2xl">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold text-white">Share Alpha Insight</h3>
                <button onclick="toggleModal('strategy-modal', false)" class="text-slate-500 hover:text-white"><i class="fas fa-times"></i></button>
            </div>
            <div class="space-y-4">
                <input type="text" id="input-title" class="w-full bg-slate-950 border border-slate-800 rounded-lg p-3 text-sm focus:border-sky-500 outline-none text-slate-200" placeholder="전략 제목">
                <textarea id="input-content" rows="6" class="w-full bg-slate-950 border border-slate-800 rounded-lg p-3 text-sm focus:border-sky-500 outline-none text-slate-200" placeholder="로직 및 가설 설명"></textarea>
                <button id="btn-submit-strategy" class="w-full bg-sky-600 hover:bg-sky-500 text-white font-bold py-3 rounded-lg transition-all">전략 저장</button>
            </div>
        </div>
    </div>

    <!-- [모달] 포지션 업데이트 -->
    <div id="position-modal" class="hidden fixed inset-0 z-[100] flex items-center justify-center p-4 modal-overlay">
        <div class="bg-slate-900 border border-slate-800 w-full max-w-sm rounded-2xl p-8 shadow-2xl">
            <div class="flex justify-between items-center mb-6 text-white">
                <h3 class="text-lg font-bold">Position Sync</h3>
                <button onclick="toggleModal('position-modal', false)" class="text-slate-500"><i class="fas fa-times"></i></button>
            </div>
            <div class="space-y-4">
                <input type="text" id="pos-asset" class="w-full bg-slate-950 border border-slate-800 rounded-lg p-3 text-sm uppercase text-slate-200" placeholder="Asset Ticker (예: NAS100)">
                <select id="pos-side" class="w-full bg-slate-950 border border-slate-800 rounded-lg p-3 text-sm text-slate-200">
                    <option value="LONG">LONG</option>
                    <option value="SHORT">SHORT</option>
                </select>
                <input type="text" id="pos-pnl" class="w-full bg-slate-950 border border-slate-800 rounded-lg p-3 text-sm text-slate-200" placeholder="PnL (예: +2.4%)">
                <button id="btn-submit-position" class="w-full bg-emerald-600 hover:bg-emerald-500 text-white font-bold py-3 rounded-lg transition-all">동기화 실행</button>
            </div>
        </div>
    </div>

    <!-- Firebase SDK & 비즈니스 로직 -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, addDoc, collection, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // [사용자 Firebase 설정 정보]
        const firebaseConfig = {
            apiKey: "AIzaSyDcB3T2qsVXTAQcvyCmTLOs3oG4-JKQXb8",
            authDomain: "systematic-multi-strategy.firebaseapp.com",
            projectId: "systematic-multi-strategy",
            storageBucket: "systematic-multi-strategy.firebasestorage.app",
            messagingSenderId: "610043483304",
            appId: "1:610043483304:web:1cca53180e7003f3375e9d",
            measurementId: "G-1BLY90C518"
        };

        const ALLOWED_EMAILS = ["hongjiheon@gmail.com", "venture1219@gmail.com"];
        const APP_ID = 'prop-desk-hub';

        // 앱 초기화
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();

        const btnLogin = document.getElementById('btn-login');
        const btnLogout = document.getElementById('btn-logout');
        const loginScreen = document.getElementById('login-screen');
        const mainDashboard = document.getElementById('main-dashboard');
        const emailDisplay = document.getElementById('display-user-email');
        const errorDisplay = document.getElementById('auth-error');

        // 로그인 버튼 클릭 이벤트
        btnLogin.onclick = async () => {
            errorDisplay.classList.add('hidden');
            try {
                // 팝업 로그인을 시도합니다.
                await signInWithPopup(auth, provider);
            } catch (error) {
                console.error("Login Error:", error);
                errorDisplay.textContent = `로그인 오류: ${error.message}`;
                errorDisplay.classList.remove('hidden');
                if (error.code === 'auth/popup-blocked') {
                    alert("팝업이 차단되었습니다. 브라우저 설정에서 팝업을 허용해 주세요.");
                }
            }
        };

        // 로그아웃 버튼 클릭 이벤트
        btnLogout.onclick = () => signOut(auth);

        // 인증 상태 변경 감지 (규칙 3 준수)
        onAuthStateChanged(auth, (user) => {
            if (user) {
                // 화이트리스트 이메일 체크
                if (ALLOWED_EMAILS.includes(user.email)) {
                    loginScreen.classList.add('hidden');
                    mainDashboard.classList.remove('hidden');
                    emailDisplay.textContent = `Trader: ${user.email}`;
                    // 인증 성공 후 실시간 리스너 시작
                    startRealtimeSync();
                } else {
                    alert("등록되지 않은 트레이더 계정입니다: " + user.email);
                    signOut(auth);
                }
            } else {
                loginScreen.classList.remove('hidden');
                mainDashboard.classList.add('hidden');
            }
        });

        // 실시간 데이터 동기화 함수
        function startRealtimeSync() {
            if (!auth.currentUser) return;

            // 전략 피드 구독 (규칙 1 준수된 경로)
            const strategyCol = collection(db, 'artifacts', APP_ID, 'public', 'data', 'strategies');
            onSnapshot(strategyCol, (snap) => {
                const list = document.getElementById('strategy-list');
                list.innerHTML = snap.empty ? '<div class="text-center py-20 text-slate-700 italic">공유된 전략이 없습니다.</div>' : '';
                
                const docs = snap.docs.map(d => ({id: d.id, ...d.data()}))
                                .sort((a,b) => (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0));

                docs.forEach(data => {
                    const card = document.createElement('div');
                    card.className = 'dashboard-card p-6 rounded-xl mb-4';
                    card.innerHTML = `
                        <div class="flex justify-between items-start mb-3">
                            <h3 class="text-white font-bold text-lg">${data.title}</h3>
                            <span class="text-[10px] bg-sky-500/10 text-sky-400 border border-sky-500/20 px-2 py-1 rounded font-bold uppercase tracking-widest font-mono">Alpha</span>
                        </div>
                        <p class="text-sm text-slate-400 leading-relaxed whitespace-pre-wrap">${data.content}</p>
                        <div class="mt-4 flex justify-between text-[10px] text-slate-600 font-medium border-t border-slate-800 pt-4">
                            <span><i class="far fa-user mr-1"></i>${data.authorEmail}</span>
                            <span><i class="far fa-clock mr-1"></i>${data.timestamp ? new Date(data.timestamp.seconds * 1000).toLocaleString() : '저장 중...'}</span>
                        </div>
                    `;
                    list.appendChild(card);
                });
            }, (error) => {
                console.error("Strategy Load Error:", error);
                if(error.code === 'permission-denied') {
                    alert("데이터 읽기 권한이 없습니다. Firebase 보안 규칙을 확인하세요.");
                }
            });

            // 포지션 피드 구독
            const positionCol = collection(db, 'artifacts', APP_ID, 'public', 'data', 'positions');
            onSnapshot(positionCol, (snap) => {
                const list = document.getElementById('position-list');
                document.getElementById('pos-count').textContent = snap.size;
                list.innerHTML = '';
                
                snap.docs.forEach(doc => {
                    const data = doc.data();
                    const isPlus = data.pnl && data.pnl.includes('+');
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td class="px-4 py-3 font-bold text-slate-200">${data.asset}</td>
                        <td class="px-4 py-3 ${data.side === 'LONG' ? 'text-emerald-400' : 'text-rose-400'} font-bold">${data.side}</td>
                        <td class="px-4 py-3 text-right font-mono font-bold ${isPlus ? 'text-emerald-400' : 'text-rose-400'}">${data.pnl}</td>
                    `;
                    list.appendChild(row);
                });
            }, (error) => console.error("Position Load Error:", error));
        }

        // 모달 제어 함수
        window.toggleModal = (id, show) => {
            const el = document.getElementById(id);
            if (show) el.classList.remove('hidden');
            else el.classList.add('hidden');
        };

        // 데이터 저장 로직
        document.getElementById('btn-submit-strategy').onclick = async () => {
            const title = document.getElementById('input-title').value;
            const content = document.getElementById('input-content').value;
            if (!title || !content || !auth.currentUser) return;
            
            try {
                await addDoc(collection(db, 'artifacts', APP_ID, 'public', 'data', 'strategies'), {
                    title,
                    content,
                    authorEmail: auth.currentUser.email,
                    timestamp: serverTimestamp()
                });
                toggleModal('strategy-modal', false);
                document.getElementById('input-title').value = '';
                document.getElementById('input-content').value = '';
            } catch (e) {
                alert("저장 실패: " + e.message);
            }
        };

        document.getElementById('btn-submit-position').onclick = async () => {
            const asset = document.getElementById('pos-asset').value.toUpperCase();
            const side = document.getElementById('pos-side').value;
            const pnl = document.getElementById('pos-pnl').value;
            if (!asset || !pnl || !auth.currentUser) return;
            
            try {
                await setDoc(doc(db, 'artifacts', APP_ID, 'public', 'data', 'positions', asset), {
                    asset,
                    side,
                    pnl,
                    timestamp: serverTimestamp()
                });
                toggleModal('position-modal', false);
                document.getElementById('pos-asset').value = '';
                document.getElementById('pos-pnl').value = '';
            } catch (e) {
                alert("업데이트 실패: " + e.message);
            }
        };

    </script>
</body>
</html>