<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SMS | Private Prop Desk Hub</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        @import url('https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css');
        body { font-family: 'Pretendard', sans-serif; overflow-x: hidden; }
        .dashboard-card { background: #0f172a; border: 1px solid #1e293b; transition: all 0.2s; }
        .dashboard-card:hover { border-color: #38bdf8; }
        .hidden { display: none; }
        .modal-overlay { background: rgba(2, 6, 23, 0.85); backdrop-filter: blur(4px); }
        /* 스크롤바 커스텀 */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #020617; }
        ::-webkit-scrollbar-thumb { background: #1e293b; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #334155; }
    </style>
</head>
<body class="bg-[#020617] text-slate-200">

    <!-- 1. 로그인 게이트 (Auth Guard) -->
    <div id="login-screen" class="min-h-screen flex items-center justify-center bg-slate-950 p-4">
        <div class="max-w-md w-full bg-slate-900 border border-slate-800 p-10 rounded-2xl shadow-2xl text-center">
            <div class="w-16 h-16 bg-sky-600 rounded-xl flex items-center justify-center mx-auto mb-6 shadow-lg shadow-sky-500/20">
                <i class="fas fa-user-lock text-2xl text-white"></i>
            </div>
            <h1 class="text-2xl font-bold text-white mb-2">Internal Access Only</h1>
            <p class="text-slate-400 text-sm mb-8 font-light">본 시스템은 인가된 프랍 데스크 인원만 접근 가능합니다. 사내 보안 가이드라인을 준수하십시오.</p>
            
            <button id="btn-login" class="w-full bg-sky-600 hover:bg-sky-500 text-white font-bold py-3 rounded-lg transition-all flex items-center justify-center gap-3 active:scale-95">
                <i class="fas fa-sign-in-alt"></i>
                데스크 시스템 접속
            </button>
            <p class="mt-6 text-[10px] text-slate-600 uppercase tracking-widest">Confidential Information | Proprietary Trading Dept.</p>
        </div>
    </div>

    <!-- 2. 메인 대시보드 UI -->
    <div id="main-dashboard" class="hidden">
        <!-- 네비게이션 -->
        <nav class="fixed w-full z-50 border-b border-slate-800/50 bg-[#020617]/90 backdrop-blur-md">
            <div class="max-w-[1600px] mx-auto px-4 h-16 flex justify-between items-center">
                <div class="flex items-center gap-3">
                    <div class="w-8 h-8 bg-sky-600 rounded flex items-center justify-center shadow-lg shadow-sky-500/30">
                        <span class="text-white font-bold text-xs">SMS</span>
                    </div>
                    <span class="text-lg font-bold text-white tracking-tight">Prop Desk <span class="font-light text-slate-500 text-sm ml-1">v2.5</span></span>
                </div>
                <div class="flex items-center gap-6">
                    <div class="hidden sm:flex items-center gap-2 px-3 py-1 bg-emerald-500/10 border border-emerald-500/20 rounded-full">
                        <span class="w-1.5 h-1.5 bg-emerald-500 rounded-full animate-pulse"></span>
                        <span class="text-[10px] text-emerald-500 font-bold uppercase">System Online</span>
                    </div>
                    <span class="text-xs text-slate-400 font-mono" id="display-user-id">Trader: ...</span>
                    <button id="btn-logout" class="text-[10px] text-slate-500 hover:text-rose-400 uppercase font-bold tracking-tighter transition-colors">Logout</button>
                </div>
            </div>
        </nav>

        <main class="pt-24 pb-16 px-4 max-w-[1600px] mx-auto">
            <!-- 지표 요약 섹션 (PnL / Exposure) -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
                <div class="dashboard-card p-5 rounded-lg border-emerald-500/20 bg-emerald-500/5">
                    <p class="text-slate-500 text-[10px] font-bold uppercase mb-1">Today's Total PnL</p>
                    <div class="text-2xl font-bold text-emerald-400" id="total-pnl">+$0 (0.00%)</div>
                </div>
                <div class="dashboard-card p-5 rounded-lg">
                    <p class="text-slate-500 text-[10px] font-bold uppercase mb-1">Total Positions</p>
                    <div class="text-2xl font-bold text-white" id="pos-count">0</div>
                </div>
                <div class="dashboard-card p-5 rounded-lg border-orange-500/20">
                    <p class="text-slate-500 text-[10px] font-bold uppercase mb-1">Risk Exposure</p>
                    <div class="text-2xl font-bold text-orange-400">Low</div>
                </div>
                <div class="dashboard-card p-5 rounded-lg border-sky-500/20 bg-sky-500/5">
                    <p class="text-slate-500 text-[10px] font-bold uppercase mb-1">Market Sentiment</p>
                    <div class="text-2xl font-bold text-sky-400">Neutral</div>
                </div>
            </div>

            <div class="grid lg:grid-cols-12 gap-8">
                <!-- 메인: 전략 피드 (모든 유저가 작성 가능) -->
                <div class="lg:col-span-8">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-lg font-bold text-white flex items-center gap-2">
                            <i class="fas fa-stream text-sky-500"></i> Strategy Insights
                        </h2>
                        <button onclick="toggleModal('strategy-modal', true)" class="bg-sky-600 hover:bg-sky-500 text-white px-5 py-2 rounded text-xs font-bold transition-all shadow-lg shadow-sky-600/30 flex items-center gap-2">
                            <i class="fas fa-pen-nib"></i> 새 전략 공유
                        </button>
                    </div>
                    
                    <div id="strategy-list" class="space-y-4">
                        <!-- Firestore에서 실시간으로 렌더링됨 -->
                        <div class="text-center py-20 text-slate-600 text-sm">로딩 중...</div>
                    </div>
                </div>

                <!-- 사이드바: 실시간 포지션 상황 -->
                <div class="lg:col-span-4 space-y-6">
                    <div class="dashboard-card rounded-xl overflow-hidden shadow-xl">
                        <div class="bg-slate-900 px-5 py-3 border-b border-slate-800 flex justify-between items-center">
                            <h3 class="text-[11px] font-bold text-white uppercase tracking-wider">Live Positions</h3>
                            <button onclick="toggleModal('position-modal', true)" class="text-[10px] text-sky-500 hover:underline">업데이트</button>
                        </div>
                        <div class="p-0 overflow-x-auto">
                            <table class="w-full text-[11px] text-left">
                                <thead class="bg-slate-900/50 text-slate-500 uppercase">
                                    <tr>
                                        <th class="px-4 py-2 font-bold tracking-tighter">Asset</th>
                                        <th class="px-4 py-2 font-bold tracking-tighter">Side</th>
                                        <th class="px-4 py-2 text-right font-bold tracking-tighter">Current PnL</th>
                                    </tr>
                                </thead>
                                <tbody id="position-list" class="divide-y divide-slate-800/30">
                                    <!-- 실시간 동기화됨 -->
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- 실시간 알림 보드 -->
                    <div class="dashboard-card rounded-xl overflow-hidden p-5">
                        <h3 class="text-[11px] font-bold text-white uppercase tracking-wider mb-4 flex items-center justify-between">
                            Recent Alerts
                            <span class="w-2 h-2 bg-rose-500 rounded-full"></span>
                        </h3>
                        <div class="space-y-3" id="alert-feed">
                            <div class="border-l-2 border-slate-700 pl-3 py-1">
                                <p class="text-[11px] text-slate-400 italic">현재 활성 얼러트가 없습니다.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- 전략 업로드 모달 -->
    <div id="strategy-modal" class="hidden fixed inset-0 z-[100] flex items-center justify-center p-4 modal-overlay">
        <div class="bg-slate-900 border border-slate-800 w-full max-w-xl rounded-2xl shadow-2xl p-8">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold text-white">Share New Strategy</h3>
                <button onclick="toggleModal('strategy-modal', false)" class="text-slate-500 hover:text-white"><i class="fas fa-times"></i></button>
            </div>
            <div class="space-y-4">
                <div>
                    <label class="block text-[10px] text-slate-500 uppercase font-bold mb-2 tracking-widest">Strategy Title</label>
                    <input type="text" id="input-title" class="w-full bg-slate-950 border border-slate-800 rounded-lg p-3 text-sm focus:outline-none focus:border-sky-500 transition-colors" placeholder="예: 나스닥 야간 모멘텀 돌파 v2">
                </div>
                <div>
                    <label class="block text-[10px] text-slate-500 uppercase font-bold mb-2 tracking-widest">Content & Logic</label>
                    <textarea id="input-content" rows="6" class="w-full bg-slate-950 border border-slate-800 rounded-lg p-3 text-sm focus:outline-none focus:border-sky-500 transition-colors" placeholder="전략의 로직, 타임프레임, 리스크 관리 원칙 등을 상세히 기록하세요."></textarea>
                </div>
                <button id="btn-submit-strategy" class="w-full bg-sky-600 hover:bg-sky-500 text-white font-bold py-3 rounded-lg mt-4 transition-all">전략 저장 및 공유</button>
            </div>
        </div>
    </div>

    <!-- 포지션 업데이트 모달 -->
    <div id="position-modal" class="hidden fixed inset-0 z-[100] flex items-center justify-center p-4 modal-overlay">
        <div class="bg-slate-900 border border-slate-800 w-full max-w-sm rounded-2xl shadow-2xl p-8">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-lg font-bold text-white">Update Position</h3>
                <button onclick="toggleModal('position-modal', false)" class="text-slate-500 hover:text-white"><i class="fas fa-times"></i></button>
            </div>
            <div class="space-y-4">
                <input type="text" id="pos-asset" class="w-full bg-slate-950 border border-slate-800 rounded-lg p-3 text-sm" placeholder="Ticker (예: NAS100)">
                <select id="pos-side" class="w-full bg-slate-950 border border-slate-800 rounded-lg p-3 text-sm">
                    <option value="LONG">LONG</option>
                    <option value="SHORT">SHORT</option>
                </select>
                <input type="text" id="pos-pnl" class="w-full bg-slate-950 border border-slate-800 rounded-lg p-3 text-sm" placeholder="PnL (예: +2.4%)">
                <button id="btn-submit-position" class="w-full bg-emerald-600 hover:bg-emerald-500 text-white font-bold py-3 rounded-lg transition-all">실시간 동기화</button>
            </div>
        </div>
    </div>

    <!-- Firebase SDK (GStatic CDN) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signOut, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, addDoc, collection, onSnapshot, query, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- 0. Firebase Configuration ---
        const firebaseConfig = {
            apiKey: "AIzaSyDcB3T2qsVXTAQcvyCmTLOs3oG4-JKQXb8",
            authDomain: "systematic-multi-strategy.firebaseapp.com",
            projectId: "systematic-multi-strategy",
            storageBucket: "systematic-multi-strategy.firebasestorage.app",
            messagingSenderId: "610043483304",
            appId: "1:610043483304:web:1cca53180e7003f3375e9d",
            measurementId: "G-1BLY90C518"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'prop-desk-hub';

        // --- 1. Authentication Logic ---
        const loginBtn = document.getElementById('btn-login');
        const logoutBtn = document.getElementById('btn-logout');
        const loginScreen = document.getElementById('login-screen');
        const mainDashboard = document.getElementById('main-dashboard');
        const userDisplay = document.getElementById('display-user-id');

        const initAuth = async () => {
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Auth Error:", error);
            }
        };

        loginBtn.onclick = () => initAuth();
        logoutBtn.onclick = () => signOut(auth);

        onAuthStateChanged(auth, (user) => {
            if (user) {
                loginScreen.classList.add('hidden');
                mainDashboard.classList.remove('hidden');
                userDisplay.textContent = `Trader ID: ${user.uid.substring(0, 8)}...`;
                startListeners();
            } else {
                loginScreen.classList.remove('hidden');
                mainDashboard.classList.add('hidden');
            }
        });

        // --- 2. Real-time Listening (Firestore) ---
        function startListeners() {
            if (!auth.currentUser) return;

            // 전략 피드 구독
            const strategyCol = collection(db, 'artifacts', appId, 'public', 'data', 'strategies');
            onSnapshot(strategyCol, (snapshot) => {
                const listEl = document.getElementById('strategy-list');
                listEl.innerHTML = '';
                
                if (snapshot.empty) {
                    listEl.innerHTML = '<div class="text-center py-20 text-slate-700 italic">공유된 전략이 없습니다. 첫 번째 인사이트를 올려보세요.</div>';
                    return;
                }

                const docs = snapshot.docs.map(doc => ({id: doc.id, ...doc.data()}))
                                .sort((a, b) => (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0));

                docs.forEach(data => {
                    const card = document.createElement('div');
                    card.className = 'dashboard-card p-6 rounded-xl hover:bg-slate-900/50 cursor-pointer';
                    card.innerHTML = `
                        <div class="flex justify-between items-start mb-4">
                            <h3 class="text-white font-bold">${data.title}</h3>
                            <span class="text-[10px] bg-sky-500/10 text-sky-400 border border-sky-500/20 px-2 py-1 rounded">Strategy</span>
                        </div>
                        <p class="text-xs text-slate-400 mb-4 leading-relaxed whitespace-pre-wrap">${data.content}</p>
                        <div class="flex gap-4 text-[10px] text-slate-600">
                            <span><i class="fas fa-user mr-1"></i>${data.author.substring(0, 8)}...</span>
                            <span><i class="fas fa-clock mr-1"></i>${data.timestamp ? new Date(data.timestamp.seconds * 1000).toLocaleString() : 'Saving...'}</span>
                        </div>
                    `;
                    listEl.appendChild(card);
                });
            }, (error) => console.error("Strategy Fetch Error:", error));

            // 포지션 상황 구독
            const positionCol = collection(db, 'artifacts', appId, 'public', 'data', 'positions');
            onSnapshot(positionCol, (snapshot) => {
                const posListEl = document.getElementById('position-list');
                const posCountEl = document.getElementById('pos-count');
                posListEl.innerHTML = '';
                posCountEl.textContent = snapshot.size;

                snapshot.docs.forEach(doc => {
                    const data = doc.data();
                    const isPlus = data.pnl.includes('+');
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td class="px-4 py-3 font-bold">${data.asset}</td>
                        <td class="px-4 py-3 font-medium ${data.side === 'LONG' ? 'text-emerald-400' : 'text-rose-400'}">${data.side}</td>
                        <td class="px-4 py-3 text-right font-bold ${isPlus ? 'text-emerald-400' : 'text-rose-400'}">${data.pnl}</td>
                    `;
                    posListEl.appendChild(row);
                });
            });
        }

        // --- 3. Data Writing Logic ---
        window.toggleModal = (id, show) => {
            document.getElementById(id).classList.toggle('hidden', !show);
        };

        document.getElementById('btn-submit-strategy').onclick = async () => {
            const title = document.getElementById('input-title').value;
            const content = document.getElementById('input-content').value;
            if (!title || !content) return alert("내용을 입력해주세요.");

            try {
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'strategies'), {
                    title,
                    content,
                    author: auth.currentUser.uid,
                    timestamp: serverTimestamp()
                });
                toggleModal('strategy-modal', false);
                document.getElementById('input-title').value = '';
                document.getElementById('input-content').value = '';
            } catch (e) {
                console.error("Save Error:", e);
            }
        };

        document.getElementById('btn-submit-position').onclick = async () => {
            const asset = document.getElementById('pos-asset').value.toUpperCase();
            const side = document.getElementById('pos-side').value;
            const pnl = document.getElementById('pos-pnl').value;
            if (!asset || !pnl) return;

            try {
                await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'positions', asset), {
                    asset, side, pnl, timestamp: serverTimestamp()
                });
                toggleModal('position-modal', false);
            } catch (e) { console.error(e); }
        };

    </script>
</body>
</html>